# 幂等有几种实现方式

本文尝试围绕软件工程中的幂等概念展开进行解释。

## 什么是幂等

幂等是指一次和多次调用某一个接口应该具有同样的结果。也就是说，对于同一种行为，如果执行不论多少次，最终的结果都是一致相同的，
就称这种行为是幂等的。在编程语言中，函数是幂等性的完美体现，不过面试中通常指的是幂等接口。

此外，与幂等高度相似的另一个设计是**防重**。

## 防重与幂等

防重与幂等是软件工程中两个存在交叉的处理重复提交的设计理念。**防重**是为了避免重复提交产生（不希望的）重复或错误的数据。
**幂等**在防重的基础上，还要求在相同参数的情况下服务端必须返回相同的结果。

**本质**

两者都要求业务提供唯一性参数，然后再进行<u>去重</u>。

**相同点**

防重与幂等的相同点在于都需要处理重复请求，所以它们的应用场景基本一致，但侧重点不同。

**不同点**

防重是针对客户端的，其解决方案可以返回错误信息，或者提示用户重复提交。
而幂等是针对服务端的，要求服务端必须返回相同的结果。具体场景中，采用防重还是幂等取决于我们的侧重点。

**触发场景**

- 前端重复提交：用户可能重复操作或刷新页面，可能导致表单重复提交，系统应保证这些操作只执行一次。
- 消息重复消费：在使用分布式消息队列时，可能会发生消息重复消费的情况，系统需要确保即使消息被重复处理，也不会影响最终状态。
- 定时任务设置不合理：如果定时任务配置不当，可能会导致数据被重复处理。幂等性设计可以确保即使任务重复执行，也不会产生错误的影响。
- 接口重试机制：例如Nginx重试、RPC通信重试或业务层重试等，可能导致请求被多次执行。系统需要能够处理这些重复的调用。
- 并发调用。

**要求幂等的场景示例**

- 领红包：一个用户对于同一个红包，领多次与领一次的效果相同。
- 创建订单：同一时间同一页面的下单按钮，点多次和点一次的效果相同。
- 订单状态变更：同一时间同一页面的「确认收货」按钮，点多次和点一次的效果相同。
- 消息消费：同一消息ID的消息，消费多次和消费一次的效果相同。

## 解决方案

防重和幂等都首先要求请求来源提供一个**唯一性参数**，其次是根据场景来选择合适的方案。下面是一些常见的方案以及对应场景。

- Token机制：适用于创建数据的场景，例如创建订单。
- 乐观锁：适用于冲突概率低的更新数据的场景，例如订单更新。
- 悲观锁：适用于冲突概率高的创建或更新数据的场景，例如抢红包、抢券。
- 数据库唯一索引：适用性较广，例如重复提交、创建订单、抢红包、消息消费。
  - 并且也是唯一一种可以保证非并发的持久性幂等方案。

幂等在防重的基础上需要额外做一些查询的步骤，即查询该唯一参数的操作结果。

### 1. Token机制

此方案采用类似令牌桶的设计，要求每个请求携带一个唯一Token，服务器保证每个Token只能使用一次（Token一般也是由服务器提供）。
具体步骤：

1. 客户端在前续步骤（如下单流程中的「填写各项订单」步骤）中从服务器获取一个唯一Token（服务器生成唯一ID放在缓存中，并设置过期）；
2. 客户端在点击提交按钮时，携带Token提交请求；
3. 服务器通过一种**原子性操作**从缓存中查询并取出Token，如可以获取到Token，则允许执行后续步骤。否则中断执行，因为Token已使用或已过期；

其中唯一ID生成可以采用雪花算法；原子性的**查询并取出Token**可以使用Redis的Lua脚本实现。

> 幂等要求获取不到Token时，查询Token在数据库中的记录，并返回结果。

### 2. 乐观锁

乐观锁是一种数据库实现的基于版本号的并发控制模式，一般应用于数据更新的场景，例如订单更新。

具体步骤：

1. 首先为数据表添加一个版本号字段，用于记录数据更新时的版本号。
2. 无需开启事务，数据更新前先获取数据最新版本号，假设 ver=1；
3. 执行数据更新，同时更新版本号，Where条件中包含 ver=1；
4. 若RowAffected = 1，则更新成功，可以执行其他更新操作；否则更新失败，返回错误信息。

乐观锁适用于冲突概率较低的场景，这样可以提高数据库性能。

> 若要更新的字段可以作为Where条件（如订单状态），比如状态从未支付到已支付，此时可以无需使用版本号，直接利用订单状态作为附加条件即可。

### 3. 悲观锁

悲观锁假设冲突概率较高，为了避免大部分无效的数据库操作，所以在操作数据前获取排他锁，操作完成后释放锁。
对于插入数据的场景，可以使用分布式锁（未建立数据库唯一索引）；对于更新数据的场景，可以使用数据库排他锁（`FOR UPDATE`）。

> 分布式锁也是悲观锁的一种实现方式。

### 4. 数据库唯一索引

对于一些低冲突操作的场景，例如重复提交、创建订单、抢红包、消息消费等，可以采用数据库唯一索引来保证事务的唯一性。具体步骤是在数据表中为业务的唯一参数列添加一个唯一索引，
然后在创建数据时通过数据库是否返回重复错误码来识别数据是否已经创建。

> 对于抢红包场景，冲突仅来源于单个用户的重复点击，所以也是低冲突的场景。
